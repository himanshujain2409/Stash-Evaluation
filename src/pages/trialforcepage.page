<apex:page controller="TrialForceOrgController">

    <apex:includeScript value="{!URLFOR($Resource.KendoUI, '/js/jquery.min.js')}" />
    <apex:includeScript value="{!URLFOR($Resource.KendoUI, '/js/kendo.all.min.js')}" />
    <apex:stylesheet value="{!URLFOR($Resource.KendoUI, '/styles/kendo.common.min.css')}" />
    <apex:stylesheet value="{!URLFOR($Resource.KendoUI, '/styles/kendo.default.min.css')}" />
    <div id="outerdiv">
   <apex:form >  
      <!-- A new value will be set to the apex:param -->
      <apex:actionFunction name="passStringToController" action="{!updateJSONToDB}" rerender="outputID">
        <apex:param name="p1" value="" assignTo="{!jstring}" />
        </apex:actionFunction>
         <apex:pageBlock title="My demo orgs" rendered="{!trialforceorgs.size!=0}" >

            <apex:pageBlockSection columns="1">
                <apex:pageBlockSectionItem >
                    <table id="user-table"></table>
                </apex:pageBlockSectionItem>
                    
               
            </apex:pageBlockSection>


          
        
        </apex:pageBlock>
        </apex:form>
    </div>

         <script>
function setupSubmit() {            
    // var outString = "";
    // $(".submitToControllerBtn").val("setupSubmit ready");
    
    outArray.length = 0;
    for(var i = 0, len = data.length; i < len; i++) {
        if (JSON.stringify(data[i]) !== JSON.stringify(dataCopy[i])){
            outArray.push(data[i]);
            console.log("new:  " + JSON.stringify(data[i]) + "old: " + JSON.stringify(dataCopy[i]) );
        }
    }

}  

// not UI function, support array operation
function arrayObjectIndexOf(myArray, searchTerm, property) {
    for(var i = 0, len = myArray.length; i < len; i++) {
        if (myArray[i][property] === searchTerm) return i;
    }
    return -1;
}

  
    var data = [
        <apex:repeat value="{!trialforceorgs}" var="a">
            {
                sf_id:   "{!JSENCODE(a.id)}",
                Name:               "{!JSENCODE(a.Name)}",
                ServiceRequest:              "{!JSENCODE(a.Service_Request__r.name)}",
                ApttusLicenseExp:            "{!a.Apttus_Licenses_Expiration_Date__c}",
                OrgExp:              "{!a.Org_Expiration_Date__c}",
                OrgFeature:    "{!a.Org_Description_Features__c}"
                            
            },
        </apex:repeat>
    ];
    var dataCopy = JSON.parse(JSON.stringify(data));
    var outArray  = new Array();

    $(document).ready(function() {
            
            var templ = kendo.template("<a href='/${sf_id}'>${Name}</a>");
            var temp4 = kendo.template('# var showDate = ""; if (ApttusLicenseExp != null && ApttusLicenseExp !=\'\') showDate = kendo.toString(new Date(ApttusLicenseExp),"MM/dd/yyyy");#' + '#= showDate #');
            var temp2 = kendo.template('# var showDate = ""; if (OrgExp != null && OrgExp !=\'\') showDate = kendo.toString(new Date(OrgExp),"MM/dd/yyyy");#' + '#= showDate #');
             
            $("#user-table").kendoGrid({
                dataSource: {
                    data: data,
                    schema: {
                        model: {
                            fields: {
                                Name:                 {  editable: false},
                                ServiceRequest:       {  editable: false},
                                ApttusLicenseExp:     {  editable: false},
                                OrgExp:               {  editable: false},
                                OrgFeature:            { editable: true}
                            }
                        }
                    },
                    pageSize: 10
                },
                editable: true,
                groupable: true,
                scrollable: true,
                sortable: true,
                pageable: true,
                filterable: true,
                resizable: true,
                height: 350,
                reorderable: true,
                columns: [
                    
                    { field: "Name",    width: "100px",     title: "Name", template:templ},
                    { field: "ServiceRequest",   width: "60px",  title: "ServiceRequest"},
                    { field: "ApttusLicenseExp", width: "80px",  title: "ApttusLicenseExpiration", template:temp4 },
                    { field: "OrgExp",  width: "120px",     title: "Org Expiration", template:temp2  },
                    { field: "OrgFeature",  width: "200px",     title: "Org Features"  }
                ],
                saveChanges: function(e) {
                    if (!confirm("Are you sure you want to save all changes?")) {
                        e.preventDefault();
                    }
                    var grid = $("#user-table").data("kendoGrid");
                    data = JSON.parse(JSON.stringify(grid.dataSource.data()));
                    //console.log('data: ' + JSON.stringify(grid.dataSource.data()));
                    setupSubmit();
                    passStringToController(JSON.stringify(outArray));
                },
                toolbar: ["save"]

            });
           
        });
   
   
   </script>
</apex:page>